# DDos攻击
## 背景
某个接口单日访问量达50万次，单周访问量达450万次，每日访问量基本处于20万+次,最高达50万+，导致客户方某个认证服务器崩溃
## 原因分析
* 代码锁死原因  
	如果是代码锁死，在代码异常时进入死循环，正常情况下重启部署服务器，释放掉锁死的线程，重新调用接口应该是会回归正常调用访问量。但是实际上重启服务器后接口频繁调动情况依然存在没有改观
* 网络原因  
	正常进入系统情况下，调整网络状态-网络处于Fast 3G或者Slow 3G的情况下，执行请求接口、登录登出等边缘测试，没有复现高访问量场景
* 账号异常原因  
	在可以正常登录的账号情况下，调整系统的账号信息，对sso单点登录状态信息不调整，sso登录是正常，系统登录会异常的边缘测试场景，依然没有复现高访问量场景
* 黑客攻击
	基于问题1/2/3下的原因分析前提下，黑客攻击的概率很大
## 处理思路
通过客户端的ip去反查访问者地址及其他相关信息。或者直接封禁访问者IP
## 网络环境
* 部署方  
访问网络先通过华为云7层elb（负载均衡）再转发给网关应用然后转给子应用，要获取ip，只能通过华为云透传给网关，网关再去接收传递下来的ip参数。
* 客户方  
客户方的专线是通过NAT(网络协议)转换后的ip地址，所以在上一步获取ip地址还需要通过客户方再进行NAT（反转换）加上精确到毫秒级别的时戳，去反查，才能找到真实的客户端地址。

## 具体实现
IP地址首先通过elb透传给前端nginx，再由nginx转发给后端api
实际测试过程中，只需要通过elb透传，在后端使用spring-boot常规方法即可获取IP。
此时获取的IP都是经由nat转换后的，还需要再通过nat反向转换，才能获取真实的原始IP。
## 结局
客户在系统使用时，用户开发了一款Chrome 插件,插件包含免登录。查询系统内信息等功能。然而插件内部代码逻辑存在风险
1. 查询系统内部接口时，如果失败就重新访问高频接口，3min后循环调用系统接口继续查询，如果系统接口调用成功没有返回或者返回值异常继续重新调用系统接口，系统接口中又会重新调用高频接口-480天/次
2. 插件作者在调用自己部署的服务器接口的返回值后，如果失败5秒后重新调用方法本身，方法中又会重新调用高频接口和1中的系统接口，max=17280天/次
3. 由于网络原因导致的接口异常或者电脑息屏等不可控因素，在插件内部逻辑不完整的情况下，会引起更大级数级别的访问量。
## DDOS代码预防实现：
基于对正常ip访问量的分析之上，预防逻辑在高频访问接口中，5分钟内，ip的出现次数如果大于40次，直接return，如果没有，正常运行。进行高频访问ip清洗。